-- Test counts by GROUP_TEST_ID for data validation
-- Shows total count per test type to compare against application
-- Parameters:
--   :start_date  YYYYMMDD  inclusive
--   :end_date    YYYYMMDD  inclusive
SELECT
    tr.GROUP_TEST_ID,
    COUNT(DISTINCT tr.ORDER_AA_ID || '-' || tr.GROUP_TEST_ID) AS TEST_COUNT
FROM V_P_LAB_TEST_RESULT tr
    INNER JOIN V_P_LAB_ORDER o ON o.AA_ID = tr.ORDER_AA_ID
    INNER JOIN V_P_LAB_STAY s ON s.AA_ID = o.STAY_AA_ID
    INNER JOIN V_P_LAB_PATIENT p ON p.AA_ID = s.PATIENT_AA_ID
WHERE
    REGEXP_LIKE(p.ID, '^E[0-9]+$')
    AND tr.STATE IN ('Final', 'Corrected')
    AND tr.RESULT <> '.'
    AND tr.VERIFIED_DT >= TO_DATE(:start_date, 'YYYYMMDD')
    AND tr.VERIFIED_DT < TO_DATE(:end_date, 'YYYYMMDD') + 1
GROUP BY tr.GROUP_TEST_ID
ORDER BY TEST_COUNT DESC;
