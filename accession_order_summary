-- Accession summary: order count, specimens collected, tests ordered
-- Filters: excludes all cancelled records; requires >=1 verified result per order;
--          excludes orders where every verified result is '.' (not a true order)
-- Parameters:
--   :start_date  YYYYMMDD  inclusive  (e.g. 20250101 for annual, 20250101 for monthly)
--   :end_date    YYYYMMDD  inclusive  (e.g. 20251231 for annual, 20250131 for monthly)
WITH
    verified_orders AS (
        -- Qualifying orders: >=1 verified result, at least one result is not '.'
        SELECT
            o.AA_ID AS order_aa_id,
            o.ID    AS accession
        FROM V_P_LAB_ORDER o
            INNER JOIN V_P_LAB_TEST_RESULT tr
                ON tr.ORDER_AA_ID = o.AA_ID
        WHERE
            o.ORDERED_DT >= TO_DATE(:start_date, 'YYYYMMDD')
            AND o.ORDERED_DT <  TO_DATE(:end_date, 'YYYYMMDD') + 1
            AND tr.STATE IN ('Final', 'Corrected')
        GROUP BY o.AA_ID, o.ID
        HAVING
            COUNT(*)                                               >= 1
            AND SUM(CASE WHEN tr.RESULT <> '.' THEN 1 ELSE 0 END) > 0
    ),
    specimens AS (
        -- Collected, non-cancelled specimens per order (routed through tube linkage)
        SELECT
            Tube.ORDER_AA_ID,
            COUNT(DISTINCT Spec.AA_ID) AS specimens_collected
        FROM V_P_LAB_TUBE Tube
            INNER JOIN V_P_LAB_SPECIMEN Spec
                ON Spec.AA_ID = Tube.SPECIMEN_AA_ID
        WHERE
            Spec.COLLECTION_DT          IS NOT NULL
            AND NVL(Spec.IS_CANCELLED, 'N') = 'N'
        GROUP BY Tube.ORDER_AA_ID
    ),
    tests AS (
        -- Non-cancelled ordered tests per order
        SELECT
            ot.ORDER_AA_ID,
            COUNT(*) AS tests_ordered
        FROM V_P_LAB_ORDERED_TEST ot
        WHERE
            ot.CANCELLED_FLAG = 0
        GROUP BY ot.ORDER_AA_ID
    )
SELECT
    COUNT(*)                                            AS TOTAL_ORDERS,
    SUM(COALESCE(sp.specimens_collected, 0))            AS SPECIMENS_COLLECTED,
    SUM(COALESCE(ts.tests_ordered, 0))                  AS TESTS_ORDERED
FROM verified_orders vo
    LEFT JOIN specimens sp
        ON sp.ORDER_AA_ID = vo.order_aa_id
    LEFT JOIN tests ts
        ON ts.ORDER_AA_ID = vo.order_aa_id;
