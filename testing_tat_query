SELECT
  pt.LAST_NAME || ',' || pt.FIRST_NAME AS PTNAME,
  o.ID AS ORDNUM,
  ti.BARCODE AS BARCODE,
  o.ORDERING_CLINIC_ID AS ORDWARD,
  st.CLINIC_ID AS PTWARD,
  otst.CANCELLED_FLAG AS CANC,
  otst.TEST_ID AS TEST_ID,
  MAX(tr.COLLECT_DT) AS COLLDT,
  TO_CHAR(tr.COLLECT_DT, 'YYYYMMDD') AS COLLDATE,
  MAX(tr.RECEIVE_DT) AS RECDT,
  tr.VERIFIED_DT AS VERDT,
  o.COLLECT_CENTER_ID AS DEPOT,
  tr.STATE AS RESULT_STATE,
  CASE
    WHEN tr.STATE <> 'Verified' THEN 'Result(s) Pending'
  END AS STATUS_DESC,
  pt.ID AS MRN
FROM V_P_LAB_PATIENT pt
  INNER JOIN V_P_LAB_STAY st
    ON st.PATIENT_AA_ID = pt.AA_ID
  INNER JOIN V_P_LAB_ORDER o
    ON o.STAY_AA_ID = st.AA_ID
  INNER JOIN V_P_LAB_ORDERED_TEST otst
    ON otst.ORDER_AA_ID = o.AA_ID
  INNER JOIN V_P_LAB_TEST_RESULT tr
    ON tr.ORDER_AA_ID = otst.ORDER_AA_ID
    AND tr.GROUP_TEST_ID = otst.TEST_ID
    AND tr.ORDERING_WORKSTATION_ID = otst.WORKSTATION_ID
  INNER JOIN V_P_LAB_TUBEINFO ti
    ON ti.ORDER_ID = otst.ORDER_NO
WHERE otst.CANCELLED_FLAG = 0
  AND tr.COLLECT_DT >= TO_DATE(:Date1, 'YYYYMMDD')
  AND tr.COLLECT_DT <  TO_DATE(:Date2, 'YYYYMMDD') + 1
  AND tr.VERIFIED_DT IS NULL
  AND otst.TEST_ID IN ('SOFIA', 'SOFII')
  AND (
    INSTR(',' || UPPER(:SITE1) || ',', ',' || o.COLLECT_CENTER_ID || ',') > 0
    OR o.COLLECT_CENTER_ID LIKE :SITE1
  )
GROUP BY
  pt.LAST_NAME || ',' || pt.FIRST_NAME,
  o.ID,
  o.ORDERING_CLINIC_ID,
  st.CLINIC_ID,
  otst.CANCELLED_FLAG,
  otst.TEST_ID,
  TO_CHAR(tr.COLLECT_DT, 'YYYYMMDD'),
  tr.VERIFIED_DT,
  o.COLLECT_CENTER_ID,
  tr.STATE,
  pt.ID,
  ti.BARCODE
ORDER BY ORDNUM
