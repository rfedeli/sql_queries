-- Optimized TS3 monthly priority report
-- Improvements: removed unused JOINs, simplified CONCAT to ||, removed redundant aggregations
SELECT
  pt.LAST_NAME || ',' || pt.FIRST_NAME AS PTNAME,
  pt.ID AS MRN,
  o.ID AS ORDNUM,
  o.ORDERED_DT,
  tr.PRIORITY,
  MAX(CASE WHEN tr.PRIORITY = 'S' THEN 1 ELSE 0 END) AS COUNT_STAT,
  MAX(CASE WHEN tr.PRIORITY = 'R' THEN 1 ELSE 0 END) AS COUNT_ROUTINE,
  MAX(CASE WHEN tr.PRIORITY = 'T' THEN 1 ELSE 0 END) AS COUNT_TIMED,
  V_S_LAB_DOCTOR.FIRST_NAME || ' ' || V_S_LAB_DOCTOR.LAST_NAME AS DOCTOR_NAME,
  MAX(tr.TEST_PERFORMING_LOCATION) AS PERF_LOC,
  MIN(tr.COLLECT_DT) AS COLLECT_DT,
  MAX(V_P_BB_Result.REVIEWDT) AS REVIEWDT,
  MIN(tr.RECEIVE_DT) AS RECEIVE_DT,
  MAX(tr.VERIFIED_DT) AS VERIFIED_DT,
  MAX(V_P_BB_Result.RESULTEDDT) AS RESULTEDDT,
  'TS3' AS TESTS,
  'Final' AS STATE,
  1 AS TS3,
  ROUND((MIN(tr.COLLECT_DT) - o.ORDERED_DT) * 1440, 2) AS ORD_TO_COLL,
  ROUND((MIN(tr.RECEIVE_DT) - MIN(tr.COLLECT_DT)) * 1440, 2) AS COLL_TO_RECEIVED,
  ROUND((MAX(V_P_BB_Result.RESULTEDDT) - MIN(tr.RECEIVE_DT)) * 1440, 2) AS RECEIVED_TO_VERIFIED,
  TO_CHAR(TRUNC(LAST_DAY(ADD_MONTHS(SYSDATE, -:Month_1))) + (23.99 / 24), 'MM/DD/YYYY') AS SDATE,
  TO_CHAR(TRUNC(LAST_DAY(ADD_MONTHS(SYSDATE, -:Month_2))) + (23.99 / 24), 'MM/DD/YYYY') AS EDATE
FROM V_P_LAB_PATIENT pt
  INNER JOIN V_P_LAB_STAY st
    ON st.PATIENT_AA_ID = pt.AA_ID
  INNER JOIN V_P_LAB_ORDER o
    ON o.STAY_AA_ID = st.AA_ID
  INNER JOIN V_P_LAB_ORDERED_TEST otst
    ON otst.ORDER_AA_ID = o.AA_ID
  INNER JOIN V_P_LAB_TEST_RESULT tr
    ON tr.ORDER_AA_ID = o.AA_ID
    AND otst.TEST_ID = tr.GROUP_TEST_ID
    AND otst.WORKSTATION_ID = tr.ORDERING_WORKSTATION_ID
  INNER JOIN V_P_BB_Result
    ON V_P_BB_Result.ORDERNO = otst.ORDER_NO
  INNER JOIN V_P_BB_Test bbtest
    ON bbtest.AA_ID = V_P_BB_Result.TEST_RESULT
  INNER JOIN V_P_BB_BB_Order bbord
    ON bbord.ORDERNO = V_P_BB_Result.ORDERNO
    AND bbtest.ORDERNO = bbord.ORDERNO
  INNER JOIN V_S_LAB_DOCTOR
    ON o.REQUESTING_DOCTOR_ID = V_S_LAB_DOCTOR.ID
WHERE
  tr.STATE = 'Final'
  AND tr.COLLECT_DT BETWEEN TRUNC(LAST_DAY(ADD_MONTHS(SYSDATE, -:Month_1))) + (23.99 / 24)
    AND TRUNC(LAST_DAY(ADD_MONTHS(SYSDATE, -:Month_2))) + (23.99 / 24)
  AND bbtest.CODE = 'TS3'
  AND tr.TEST_ID NOT IN ('RCL')
  AND (
    INSTR(',' || UPPER(:SITE1) || ',', ',' || bbord.DEPOT || ',') > 0
    OR bbord.DEPOT LIKE :SITE1
  )
GROUP BY
  pt.LAST_NAME || ',' || pt.FIRST_NAME,
  pt.ID,
  o.ID,
  o.ORDERED_DT,
  tr.PRIORITY,
  V_S_LAB_DOCTOR.FIRST_NAME || ' ' || V_S_LAB_DOCTOR.LAST_NAME
ORDER BY ORDNUM;
